<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AutoPulse Sheetsync</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
  <style>
    body {
      margin: 0;
      background-color: #0b1220;
      color: #dce3ff;
      font-family: "Poppins", sans-serif;
    }
    header {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 600;
      padding: 20px;
      color: #4da3ff;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    .summary-box {
      background: #101a2b;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 10px #000;
      margin-bottom: 20px;
    }
    .summary-title {
      font-size: 1.3rem;
      color: #84baff;
      border-bottom: 1px solid #2b3c5a;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .summary-content {
      color: #a6b7d0;
      font-size: 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 20px;
    }
    canvas {
      background: #101a2b;
      border-radius: 15px;
      padding: 15px;
    }
    .loading {
      text-align: center;
      color: #6fa9ff;
      margin-top: 50px;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <header>AutoPulse Sheetsync</header>
  <div class="container">
    <div class="summary-box">
      <div class="summary-title">Business Intelligence Summary</div>
      <div class="summary-content" id="summary">Loading...</div>
    </div>

    <div class="grid">
      <div>
        <h3 style="color:#4da3ff;">Revenue Distribution</h3>
        <canvas id="revenueChart"></canvas>
      </div>
      <div>
        <h3 style="color:#4da3ff;">Performance Trend</h3>
        <canvas id="growthChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const summaryBox = document.getElementById("summary");
    const revCtx = document.getElementById("revenueChart").getContext("2d");
    const growthCtx = document.getElementById("growthChart").getContext("2d");

    let revChart, growthChart;

    async function fetchData() {
      try {
        summaryBox.innerText = "Loading live data...";
        const res = await fetch("/api/data");
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();

        if (!data.data || data.data.length === 0) {
          summaryBox.innerText = "No data available or Google Sheet not accessible.";
          return;
        }

        renderDashboard(data);
      } catch (err) {
        console.error(err);
        summaryBox.innerText = "Failed to connect to live data source.";
      }
    }

    function renderDashboard(response) {
      const rows = response.data;
      const updatedAt = new Date(response.updated_at).toLocaleString();

      // --- Update Summary ---
      const avgGrowth =
        rows.reduce((a, b) => a + (b.growth || 0), 0) / rows.length;
      const topCategory = rows.sort((a, b) => b.latest - a.latest)[0].category;
      summaryBox.innerHTML = `
        <b>Last Updated:</b> ${updatedAt}<br/>
        <b>Top Performing Category:</b> ${topCategory}<br/>
        <b>Average Growth:</b> ${avgGrowth.toFixed(2)}%
      `;

      const categories = rows.map((r) => r.category);
      const revenues = rows.map((r) => r.latest);
      const growthRates = rows.map((r) => r.growth);

      // --- Revenue Chart ---
      if (revChart) revChart.destroy();
      revChart = new Chart(revCtx, {
        type: "bar",
        data: {
          labels: categories,
          datasets: [
            {
              label: "Latest Revenue",
              data: revenues,
              borderWidth: 1,
              backgroundColor: "rgba(77,163,255,0.6)",
              borderColor: "#4da3ff",
            },
          ],
        },
        options: {
          scales: {
            x: { ticks: { color: "#a6b7d0" } },
            y: { ticks: { color: "#a6b7d0" } },
          },
          plugins: {
            legend: { labels: { color: "#a6b7d0" } },
          },
        },
      });

      // --- Growth Chart ---
      if (growthChart) growthChart.destroy();
      growthChart = new Chart(growthCtx, {
        type: "line",
        data: {
          labels: categories,
          datasets: [
            {
              label: "Growth (%)",
              data: growthRates,
              fill: false,
              borderColor: "#5fe4ff",
              tension: 0.3,
            },
          ],
        },
        options: {
          scales: {
            x: { ticks: { color: "#a6b7d0" } },
            y: { ticks: { color: "#a6b7d0" } },
          },
          plugins: {
            legend: { labels: { color: "#a6b7d0" } },
          },
        },
      });
    }

    fetchData();
  </script>
</body>
</html>
